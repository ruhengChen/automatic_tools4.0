--redo:
UPDATE EPAY.ONLINESUBTRANS SET MERNBR = NULL;
DELETE FROM EPAY.ONLINESUBTRANS WHERE JOB_SEQ_ID= (SELECT JOB_SEQ_ID FROM ETL.JOB_LOG WHERE TO_CHAR(DATA_PRD,'yyyymmdd')='20170524' AND JOB_NM ='AP_ODS_EPAY_ONLINESUBTRANS');
INSERT INTO EPAY.ONLINESUBTRANS(SUBTRANSSEQNBR,TRANSSEQNBR,DOWNSYSSEQNBR,CLEARDATE,MERTRANSDATE,MERTRANSDATETIME,ORIGSUBMERSEQNBR,ORIGSUBMERTRANSDATE,ORIGSUBTRANSSEQNBR,ORIGCLEARDATE,TRANSCODE,MERNBR,MEROPENDEPTNBR,MERDEVDEPTNBR,PAYERACCTKIND,PAYEEACCTKIND,PAYERCARDTYPCD,PAYEECARDTYPCD,CUSTCIFNBR,PAYERACCTNBR,PAYERACCTTYPCD,PAYERACCTDEPTNBR,PAYERACCTNAME,PAYEEACCTNBR,PAYEEACCTDEPTNBR,PAYEEACCTTYPCD,PAYEEACCTNAME,TRANSAMT,CURRENCYCD,REFUNDEDAMT,UNREFUNDAMT,TRANSAMT1,TRANSAMT2,FEEAMT,TRANSSTATUS,PROCSTEP,PROCSTATUS,MEMO1,TRANSTIME,MEMO2,DEPARTMENTNBR,SYSTEMCODE,TRANSMODE,TRANSTYPCD,PROFITSEQNBR,CONFIRMEDPAYAMT,CONFIRMEDPAYDATE,CONFIRMEDCLEARDATE,CONFIRMEDMERSEQNBR,CONFIRMEDMERDATETIME,REFUNDMODE,MERSEQNBR,TRANSDATE,PAYTYPCD,FEENBR,SUPFEENBR,ELECPORTFLAG,DATELASTMAINT,EFF_DT,END_DT,JOB_SEQ_ID) select SUBTRANSSEQNBR,TRANSSEQNBR,DOWNSYSSEQNBR,CLEARDATE,MERTRANSDATE,MERTRANSDATETIME,ORIGSUBMERSEQNBR,ORIGSUBMERTRANSDATE,ORIGSUBTRANSSEQNBR,ORIGCLEARDATE,TRANSCODE,MERNBR,MEROPENDEPTNBR,MERDEVDEPTNBR,PAYERACCTKIND,PAYEEACCTKIND,PAYERCARDTYPCD,PAYEECARDTYPCD,CUSTCIFNBR,PAYERACCTNBR,PAYERACCTTYPCD,PAYERACCTDEPTNBR,PAYERACCTNAME,PAYEEACCTNBR,PAYEEACCTDEPTNBR,PAYEEACCTTYPCD,PAYEEACCTNAME,TRANSAMT,CURRENCYCD,REFUNDEDAMT,UNREFUNDAMT,TRANSAMT1,TRANSAMT2,FEEAMT,TRANSSTATUS,PROCSTEP,PROCSTATUS,MEMO1,TRANSTIME,MEMO2,DEPARTMENTNBR,SYSTEMCODE,TRANSMODE,TRANSTYPCD,PROFITSEQNBR,CONFIRMEDPAYAMT,CONFIRMEDPAYDATE,CONFIRMEDCLEARDATE,CONFIRMEDMERSEQNBR,CONFIRMEDMERDATETIME,REFUNDMODE,MERSEQNBR,TRANSDATE,PAYTYPCD,FEENBR,SUPFEENBR,ELECPORTFLAG,DATELASTMAINT,EFF_DT,END_DT,JOB_SEQ_ID from ODSHIS.EPAY_ONLINESUBTRANS WHERE NEW_JOB_SEQ_ID= (SELECT  JOB_SEQ_ID FROM ETL.JOB_LOG WHERE TO_CHAR(DATA_PRD,'yyyymmdd')='20170524' AND JOB_NM ='AP_ODS_EPAY_ONLINESUBTRANS');
DELETE FROM ODSHIS.EPAY_ONLINESUBTRANS WHERE NEW_JOB_SEQ_ID= (SELECT  JOB_SEQ_ID FROM ETL.JOB_LOG WHERE TO_CHAR(DATA_PRD,'yyyymmdd')='20170524' AND JOB_NM ='AP_ODS_EPAY_ONLINESUBTRANS');

CREATE TABLE DELTA.EPAY_ONLINESUBTRANS_YATOPUPDATE LIKE DELTA.EPAY_ONLINESUBTRANS;
LOAD CLIENT FROM /etl/etldata/input/init/20170524/EPAY_ONLINESUBTRANS_20170524 of del replace into DELTA.EPAY_ONLINESUBTRANS_YATOPUPDATE;
MERGE INTO EPAY.ONLINESUBTRANS T USING (SELECT SUBTRANSSEQNBR,TRANSSEQNBR,MERNBR FROM DELTA.EPAY_ONLINESUBTRANS_YATOPUPDATE A WHERE NOT EXISTS (SELECT 1 FROM DELTA.EPAY_ONLINESUBTRANS B WHERE A.SUBTRANSSEQNBR=B.SUBTRANSSEQNBR AND A.TRANSSEQNBR=B.TRANSSEQNBR)) S ON T.SUBTRANSSEQNBR=S.SUBTRANSSEQNBR AND T.TRANSSEQNBR=S.TRANSSEQNBR AND T.END_DT='9999-12-31' WHEN MATCHED THEN UPDATE SET T.MERNBR=S.MERNBR;
DROP TABLE DELTA.EPAY_ONLINESUBTRANS_YATOPUPDATE;
