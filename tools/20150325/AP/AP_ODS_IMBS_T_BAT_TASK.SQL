SELECT 'Rows updated:',COUNT(1) FROM (SELECT 1 FROM DELTA.IMBS_T_BAT_TASK WHERE ETL_FLAG IN ('A','D')) S;

--REDO£ºDELETE LAST JOB LOADED DATA
DELETE FROM IMBS.T_BAT_TASK WHERE JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºRECOVERY DATA FROM HISTORY TABLE
INSERT INTO IMBS.T_BAT_TASK(PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,EFF_DT,END_DT,JOB_SEQ_ID)
select PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,EFF_DT,END_DT,JOB_SEQ_ID
from ODSHIS.IMBS_T_BAT_TASK WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºDELETE HISTORY DATA
DELETE FROM ODSHIS.IMBS_T_BAT_TASK WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--BACKUP DATA TO HISTROY TABLE
SELECT 'Rows readed:',COUNT(1),'Rows changed:',COUNT(1) FROM (SELECT 1 FROM DELTA.IMBS_T_BAT_TASK WHERE ETL_FLAG IN ('I','A','D')) S;
SELECT 'Rows updated:',COUNT(1) FROM NEW TABLE (
INSERT INTO ODSHIS.IMBS_T_BAT_TASK(PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,EFF_DT,END_DT,JOB_SEQ_ID,NEW_JOB_SEQ_ID)
select PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,EFF_DT,END_DT,JOB_SEQ_ID,New_JOB_SEQ_ID
 from IMBS.T_BAT_TASK T
WHERE T.END_DT='9999-12-31' AND EXISTS ( SELECT 1 FROM DELTA.IMBS_T_BAT_TASK S
WHERE T.PLAT_DATE=S.PLAT_DATE AND T.BAT_SEQ=S.BAT_SEQ ));

--DROP ZIPPER
MERGE INTO IMBS.T_BAT_TASK T 
USING (SELECT * FROM DELTA.IMBS_T_BAT_TASK WHERE ETL_FLAG IN ('I','D','A')) S
ON T.PLAT_DATE=S.PLAT_DATE AND T.BAT_SEQ=S.BAT_SEQ  AND T.END_DT='9999-12-31' 
   WHEN MATCHED THEN UPDATE SET 
T.END_DT='#DATEOFDATA#', T.JOB_SEQ_ID= New_JOB_SEQ_ID;

--CREATE ZIPPER
INSERT INTO IMBS.T_BAT_TASK(PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,EFF_DT,END_DT,JOB_SEQ_ID)
select PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,'#DATEOFDATA#','9999-12-31',New_JOB_SEQ_ID
from DELTA.IMBS_T_BAT_TASK where ETL_FLAG in ('A','I');

--CONFERM DATA INTEGRITY
MERGE INTO IMBS.T_BAT_TASK T 
USING (SELECT * FROM DELTA.IMBS_T_BAT_TASK WHERE ETL_FLAG = 'D' ) S
ON T.PLAT_DATE=S.PLAT_DATE AND T.BAT_SEQ=S.BAT_SEQ
WHEN NOT MATCHED THEN
INSERT (PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,EFF_DT,END_DT,JOB_SEQ_ID)
VALUES (PLAT_DATE,BAT_SEQ,BAT_STAT,BRCH_NO,OPER_NO,ENTR_NO,ENTR_NAME,HOST_SEQ_NO,BAT_MODE,BAT_TYPE,BKBZ,DET_TAB_NAME,IN_AMT_TOT,IN_NUM_TOT,IN_AMT_TOT1,IN_NUM_TOT1,START_DATA_DATE,END_DATA_DATE,OPEN_TYPE,ACCT_TYPE,TD_FLAG,TERM,DRAW_TYPE,START_INT_DATE,SET_ACCT_NO1,SET_ACCT_NO2,ACC_AMT_TOT1,ACC_NUM_TOT1,ACC_AMT_TOT2,ACC_NUM_TOT2,RECV_AMT,RECV_NUM,OPEN_NUM,FAIL_NUM,PROD_TYPE,PROD_CODE,FRZ_NO,HOST_BAT_STAT,HOST_CODE,HOST_MSG,'#DATEOFDATA#','#DATEOFDATA#',New_JOB_SEQ_ID);