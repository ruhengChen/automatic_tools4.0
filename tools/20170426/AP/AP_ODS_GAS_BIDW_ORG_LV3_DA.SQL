SELECT 'Rows updated:',COUNT(1) FROM (SELECT 1 FROM DELTA.GAS_BIDW_ORG_LV3_DA WHERE ETL_FLAG IN ('A','D')) S;

--REDO£ºDELETE LAST JOB LOADED DATA
DELETE FROM GAS.BIDW_ORG_LV3_DA WHERE JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºRECOVERY DATA FROM HISTORY TABLE
INSERT INTO GAS.BIDW_ORG_LV3_DA(ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,EFF_DT,END_DT,JOB_SEQ_ID)
select ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,EFF_DT,END_DT,JOB_SEQ_ID
from ODSHIS.GAS_BIDW_ORG_LV3_DA WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºDELETE HISTORY DATA
DELETE FROM ODSHIS.GAS_BIDW_ORG_LV3_DA WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--BACKUP DATA TO HISTROY TABLE
SELECT 'Rows readed:',COUNT(1),'Rows changed:',COUNT(1) FROM (SELECT 1 FROM DELTA.GAS_BIDW_ORG_LV3_DA WHERE ETL_FLAG IN ('I','A','D')) S;
SELECT 'Rows updated:',COUNT(1) FROM NEW TABLE (
INSERT INTO ODSHIS.GAS_BIDW_ORG_LV3_DA(ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,EFF_DT,END_DT,JOB_SEQ_ID,NEW_JOB_SEQ_ID)
select ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,EFF_DT,END_DT,JOB_SEQ_ID,New_JOB_SEQ_ID
 from GAS.BIDW_ORG_LV3_DA T
WHERE T.END_DT='9999-12-31' AND EXISTS ( SELECT 1 FROM DELTA.GAS_BIDW_ORG_LV3_DA S
WHERE T.ORG_LV3_WID=S.ORG_LV3_WID ));

--DROP ZIPPER
MERGE INTO GAS.BIDW_ORG_LV3_DA T 
USING (SELECT * FROM DELTA.GAS_BIDW_ORG_LV3_DA WHERE ETL_FLAG IN ('I','D','A')) S
ON T.ORG_LV3_WID=S.ORG_LV3_WID  AND T.END_DT='9999-12-31' 
   WHEN MATCHED THEN UPDATE SET 
T.END_DT='#DATEOFDATA#', T.JOB_SEQ_ID= New_JOB_SEQ_ID;

--CREATE ZIPPER
INSERT INTO GAS.BIDW_ORG_LV3_DA(ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,EFF_DT,END_DT,JOB_SEQ_ID)
select ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,'#DATEOFDATA#','9999-12-31',New_JOB_SEQ_ID
from DELTA.GAS_BIDW_ORG_LV3_DA where ETL_FLAG in ('A','I');

--CONFERM DATA INTEGRITY
MERGE INTO GAS.BIDW_ORG_LV3_DA T 
USING (SELECT * FROM DELTA.GAS_BIDW_ORG_LV3_DA WHERE ETL_FLAG = 'D' ) S
ON T.ORG_LV3_WID=S.ORG_LV3_WID
WHEN NOT MATCHED THEN
INSERT (ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,EFF_DT,END_DT,JOB_SEQ_ID)
VALUES (ORG_LV3_WID,ORG_LV0_CODE,ORG_LV0_NAME,ORG_LV0_DESC,ORG_LV0_S1_CODE,ORG_LV0_S1_NAME,ORG_LV0_S1_DESC,ORG_LV1_CODE,ORG_LV1_NAME,ORG_LV1_DESC,ORG_LV2_S1_CODE,ORG_LV2_S1_NAME,ORG_LV2_S1_DESC,ORG_LV2_CODE,ORG_LV2_NAME,ORG_LV2_DESC,ORG_LV3_CODE,ORG_LV3_NAME,ORG_LV3_DESC,ATTRIBUTE10,ATTRIBUTE11,DATASOURCE_NUM_ID,INTEGRATION_ID,DELETE_FLG,ENABLE_FLG,START_DT_ACTIVE,END_DT_ACTIVE,CCSX_FLAG,SX_FLAG,'#DATEOFDATA#','#DATEOFDATA#',New_JOB_SEQ_ID);