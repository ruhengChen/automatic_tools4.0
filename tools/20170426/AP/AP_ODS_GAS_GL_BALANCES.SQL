SELECT 'Rows updated:',COUNT(1) FROM (SELECT 1 FROM DELTA.GAS_GL_BALANCES WHERE ETL_FLAG IN ('A','D')) S;

--REDO£ºDELETE LAST JOB LOADED DATA
DELETE FROM GAS.GL_BALANCES WHERE JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºRECOVERY DATA FROM HISTORY TABLE
INSERT INTO GAS.GL_BALANCES(LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,EFF_DT,END_DT,JOB_SEQ_ID)
select LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,EFF_DT,END_DT,JOB_SEQ_ID
from ODSHIS.GAS_GL_BALANCES WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºDELETE HISTORY DATA
DELETE FROM ODSHIS.GAS_GL_BALANCES WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--BACKUP DATA TO HISTROY TABLE
SELECT 'Rows readed:',COUNT(1),'Rows changed:',COUNT(1) FROM (SELECT 1 FROM DELTA.GAS_GL_BALANCES WHERE ETL_FLAG IN ('I','A','D')) S;
SELECT 'Rows updated:',COUNT(1) FROM NEW TABLE (
INSERT INTO ODSHIS.GAS_GL_BALANCES(LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,EFF_DT,END_DT,JOB_SEQ_ID,NEW_JOB_SEQ_ID)
select LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,EFF_DT,END_DT,JOB_SEQ_ID,New_JOB_SEQ_ID
 from GAS.GL_BALANCES T
WHERE T.END_DT='9999-12-31' AND EXISTS ( SELECT 1 FROM DELTA.GAS_GL_BALANCES S
WHERE T.LEDGER_ID=S.LEDGER_ID AND T.ORG_ID=S.ORG_ID AND T.SUB_BR_ORG_ID=S.SUB_BR_ORG_ID AND T.SUBJECT_ID=S.SUBJECT_ID AND T.PRODUCT_ID=S.PRODUCT_ID AND T.SOURCE_TYPE=S.SOURCE_TYPE AND T.CHANNEL_TYPE=S.CHANNEL_TYPE AND T.MERGE_NV_CD=S.MERGE_NV_CD AND T.CURRENCY_CODE=S.CURRENCY_CODE AND T.PERIOD_NAME=S.PERIOD_NAME AND T.ACTUAL_FLAG=S.ACTUAL_FLAG ));

--DROP ZIPPER
MERGE INTO GAS.GL_BALANCES T 
USING (SELECT * FROM DELTA.GAS_GL_BALANCES WHERE ETL_FLAG IN ('I','D','A')) S
ON T.LEDGER_ID=S.LEDGER_ID AND T.ORG_ID=S.ORG_ID AND T.SUB_BR_ORG_ID=S.SUB_BR_ORG_ID AND T.SUBJECT_ID=S.SUBJECT_ID AND T.PRODUCT_ID=S.PRODUCT_ID AND T.SOURCE_TYPE=S.SOURCE_TYPE AND T.CHANNEL_TYPE=S.CHANNEL_TYPE AND T.MERGE_NV_CD=S.MERGE_NV_CD AND T.CURRENCY_CODE=S.CURRENCY_CODE AND T.PERIOD_NAME=S.PERIOD_NAME AND T.ACTUAL_FLAG=S.ACTUAL_FLAG  AND T.END_DT='9999-12-31' 
   WHEN MATCHED THEN UPDATE SET 
T.END_DT='#DATEOFDATA#', T.JOB_SEQ_ID= New_JOB_SEQ_ID;

--CREATE ZIPPER
INSERT INTO GAS.GL_BALANCES(LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,EFF_DT,END_DT,JOB_SEQ_ID)
select LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,'#DATEOFDATA#','9999-12-31',New_JOB_SEQ_ID
from DELTA.GAS_GL_BALANCES where ETL_FLAG in ('A','I');

--CONFERM DATA INTEGRITY
MERGE INTO GAS.GL_BALANCES T 
USING (SELECT * FROM DELTA.GAS_GL_BALANCES WHERE ETL_FLAG = 'D' ) S
ON T.LEDGER_ID=S.LEDGER_ID AND T.ORG_ID=S.ORG_ID AND T.SUB_BR_ORG_ID=S.SUB_BR_ORG_ID AND T.SUBJECT_ID=S.SUBJECT_ID AND T.PRODUCT_ID=S.PRODUCT_ID AND T.SOURCE_TYPE=S.SOURCE_TYPE AND T.CHANNEL_TYPE=S.CHANNEL_TYPE AND T.MERGE_NV_CD=S.MERGE_NV_CD AND T.CURRENCY_CODE=S.CURRENCY_CODE AND T.PERIOD_NAME=S.PERIOD_NAME AND T.ACTUAL_FLAG=S.ACTUAL_FLAG
WHEN NOT MATCHED THEN
INSERT (LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,EFF_DT,END_DT,JOB_SEQ_ID)
VALUES (LEDGER_ID,ORG_ID,SUB_BR_ORG_ID,SUBJECT_ID,PRODUCT_ID,SOURCE_TYPE,CHANNEL_TYPE,MERGE_NV_CD,REMARK1,REMARK2,CURRENCY_CODE,PERIOD_NAME,ACTUAL_FLAG,BUDGET_VERSION_ID,TRANSLATED_FLAG,REVALUATION_STATUS,PERIOD_TYPE,PERIOD_YEAR,PERIOD_NUM,PERIOD_NET_DR,PERIOD_NET_CR,PERIOD_TO_DATE_ADB,QUARTER_TO_DATE_DR,QUARTER_TO_DATE_CR,QUARTER_TO_DATE_ADB,YEAR_TO_DATE_ADB,PROJECT_TO_DATE_DR,PROJECT_TO_DATE_CR,PROJECT_TO_DATE_ADB,BEGIN_BALANCE_DR,BEGIN_BALANCE_CR,PERIOD_NET_DR_BEQ,PERIOD_NET_CR_BEQ,BEGIN_BALANCE_DR_BEQ,BEGIN_BALANCE_CR_BEQ,TEMPLATE_ID,QUARTER_TO_DATE_DR_BEQ,QUARTER_TO_DATE_CR_BEQ,PROJECT_TO_DATE_DR_BEQ,PROJECT_TO_DATE_CR_BEQ,'#DATEOFDATA#','#DATEOFDATA#',New_JOB_SEQ_ID);