SELECT 'Rows updated:',COUNT(1) FROM (SELECT 1 FROM DELTA.GAS_GL_JE_HEADERS WHERE ETL_FLAG IN ('A','D')) S;

--REDO£ºDELETE LAST JOB LOADED DATA
DELETE FROM GAS.GL_JE_HEADERS WHERE JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºRECOVERY DATA FROM HISTORY TABLE
INSERT INTO GAS.GL_JE_HEADERS(JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,EFF_DT,END_DT,JOB_SEQ_ID)
select JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,EFF_DT,END_DT,JOB_SEQ_ID
from ODSHIS.GAS_GL_JE_HEADERS WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--REDO£ºDELETE HISTORY DATA
DELETE FROM ODSHIS.GAS_GL_JE_HEADERS WHERE NEW_JOB_SEQ_ID= New_JOB_SEQ_ID;

--BACKUP DATA TO HISTROY TABLE
SELECT 'Rows readed:',COUNT(1),'Rows changed:',COUNT(1) FROM (SELECT 1 FROM DELTA.GAS_GL_JE_HEADERS WHERE ETL_FLAG IN ('I','A','D')) S;
SELECT 'Rows updated:',COUNT(1) FROM NEW TABLE (
INSERT INTO ODSHIS.GAS_GL_JE_HEADERS(JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,EFF_DT,END_DT,JOB_SEQ_ID,NEW_JOB_SEQ_ID)
select JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,EFF_DT,END_DT,JOB_SEQ_ID,New_JOB_SEQ_ID
 from GAS.GL_JE_HEADERS T
WHERE T.END_DT='9999-12-31' AND EXISTS ( SELECT 1 FROM DELTA.GAS_GL_JE_HEADERS S
WHERE T.JE_HEADER_ID=S.JE_HEADER_ID ));

--DROP ZIPPER
MERGE INTO GAS.GL_JE_HEADERS T 
USING (SELECT * FROM DELTA.GAS_GL_JE_HEADERS WHERE ETL_FLAG IN ('I','D','A')) S
ON T.JE_HEADER_ID=S.JE_HEADER_ID  AND T.END_DT='9999-12-31' 
   WHEN MATCHED THEN UPDATE SET 
T.END_DT='#DATEOFDATA#', T.JOB_SEQ_ID= New_JOB_SEQ_ID;

--CREATE ZIPPER
INSERT INTO GAS.GL_JE_HEADERS(JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,EFF_DT,END_DT,JOB_SEQ_ID)
select JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,'#DATEOFDATA#','9999-12-31',New_JOB_SEQ_ID
from DELTA.GAS_GL_JE_HEADERS where ETL_FLAG in ('A','I');

--CONFERM DATA INTEGRITY
MERGE INTO GAS.GL_JE_HEADERS T 
USING (SELECT * FROM DELTA.GAS_GL_JE_HEADERS WHERE ETL_FLAG = 'D' ) S
ON T.JE_HEADER_ID=S.JE_HEADER_ID
WHEN NOT MATCHED THEN
INSERT (JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,EFF_DT,END_DT,JOB_SEQ_ID)
VALUES (JE_HEADER_ID,LAST_UPDATE_DATE,LAST_UPDATED_BY,LEDGER_ID,JE_CATEGORY,JE_SOURCE,PERIOD_NAME,NAME,CURRENCY_CODE,STATUS,DATE_CREATED,ACCRUAL_REV_FLAG,ACTUAL_FLAG,DEFAULT_EFFECTIVE_DATE,TAX_STATUS_CODE,CONVERSION_FLAG,CREATION_DATE,CREATED_BY,BALANCED_JE_FLAG,JE_BATCH_ID,FROM_RECURRING_HEADER_ID,EARLIEST_POSTABLE_DATE,POSTED_DATE,ACCRUAL_REV_EFFECTIVE_DATE,ACCRUAL_REV_PERIOD_NAME,ACCRUAL_REV_STATUS,ACCRUAL_REV_JE_HEADER_ID,ACCRUAL_REV_CHANGE_SIGN_FLAG,DESCRIPTION,CONTROL_TOTAL,RUNNING_TOTAL_DR,RUNNING_TOTAL_CR,RUNNING_TOTAL_ACCOUNTED_DR,RUNNING_TOTAL_ACCOUNTED_CR,CURRENCY_CONVERSION_RATE,CURRENCY_CONVERSION_TYPE,CURRENCY_CONVERSION_DATE,EXTERNAL_REFERENCE,REVERSED_JE_HEADER_ID,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,CONTEXT,DOC_SEQUENCE_ID,DOC_SEQUENCE_VALUE,JE_FROM_SLA_FLAG,'#DATEOFDATA#','#DATEOFDATA#',New_JOB_SEQ_ID);